<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laam Wallet ‚Äî Modern</title>
<link rel="icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png" />
<!-- Stellar SDK & CryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
  :root{
    --bg1:#5aa0ff; --bg2:#9b6bff;
    --card:#ffffffcc; --glass: rgba(255,255,255,0.75);
    --muted:#6b7280; --brand:#1976d2; --accent:#00c6a7;
    --radius:18px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased;
    display:flex;align-items:flex-start;justify-content:center;padding:28px;
  }

  .shell{
    width:100%;max-width:460px;
  }

  /* Header */
  .header{
    display:flex;align-items:center;gap:12px;margin-bottom:18px;
  }
  .logo{
    width:64px;height:64px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
  }
  .title{
    color:#fff;font-weight:800;font-size:28px;text-shadow:0 2px 8px rgba(0,0,0,0.15);
  }

  /* Card for balances */
  .card{
    background:var(--card);
    border-radius:22px;
    padding:18px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.12);
    backdrop-filter: blur(6px);
    margin-bottom:18px;
  }
  .balances{
    display:grid;grid-template-columns:1fr;gap:10px;
  }
  .asset-row{
    display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:#fff;
    box-shadow:0 6px 14px rgba(12,20,50,0.04);
  }
  .asset-left{display:flex;align-items:center;gap:12px}
  .asset-icon{
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#e6f0ff,#d9e8ff);display:flex;align-items:center;justify-content:center;
    font-weight:800;color:var(--brand);
  }
  .asset-name{font-weight:700;color:#0b2340}
  .asset-sub{font-size:12px;color:var(--muted);margin-top:2px}

  .asset-right{text-align:right}
  .asset-balance{font-weight:800;font-size:18px;color:#08122a}
  .asset-fiat{font-size:13px;color:var(--muted);margin-top:2px}

  /* Actions grid */
  .actions{
    display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;
  }
  .action-btn{
    background:linear-gradient(180deg,#fff,#fff);
    border-radius:16px;padding:18px;text-align:center;box-shadow:0 8px 18px rgba(2,6,23,0.08);
    cursor:pointer;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  }
  .action-icon{
    width:58px;height:58px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;
    box-shadow:0 6px 14px rgba(2,6,23,0.08);
  }
  .send .action-icon{background:linear-gradient(135deg,#2d9cff,#1976d2)}
  .receive .action-icon{background:linear-gradient(135deg,#2dd4bf,#00b894)}
  .swap .action-icon{background:linear-gradient(135deg,#8b5cf6,#6b46c1)}
  .trust .action-icon{background:linear-gradient(135deg,#42a5f5,#00c6a7)}

  .action-label{font-weight:700;color:#0b2340}

  /* Small controls */
  .top-controls{display:flex;gap:8px;margin-top:14px}
  .control-btn{padding:10px 12px;border-radius:12px;border:none;background:#ffffff33;color:#fff;font-weight:700;cursor:pointer}
  .small-note{color:#eef2ff;font-size:13px;margin-top:10px}

  /* Send form modal (simple inline) */
  .send-panel{margin-top:12px;background:#ffffffee;padding:14px;border-radius:12px;display:none;box-shadow:0 8px 20px rgba(3,10,30,0.06)}
  .send-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{display:block;font-weight:700;color:#0b2340;margin-top:8px;font-size:13px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;box-sizing:border-box}
  .muted-2{color:#52606d;font-size:13px}

  /* footer spacing */
  .footer-space{height:30px}
  @media (max-width:420px){
    .title{font-size:22px}
    .asset-icon{width:40px;height:40px}
    .action-icon{width:50px;height:50px}
  }
</style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo"><img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="logo" style="width:42px;height:42px;border-radius:8px"></div>
      <div class="title">Laam wallet</div>
    </div>

    <!-- Balances card -->
    <div class="card" id="balancesCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800;color:#08122a">Balances</div>
        <div style="font-size:13px;color:var(--muted)">Total: $<span id="totalAssets">0</span></div>
      </div>

      <div class="balances" id="balancesList">
        <!-- rows inserted by JS -->
      </div>

      <div class="small-note">Tip: fund account with at least 4 XLM to activate.</div>
    </div>

    <!-- Actions grid -->
    <div class="card" style="margin-top:12px">
      <div style="font-weight:800;color:#08122a;margin-bottom:10px">Quick actions</div>
      <div class="actions">
        <button class="action-btn send" id="openSend">
          <div class="action-icon">‚úàÔ∏è</div>
          <div class="action-label">Send</div>
        </button>

        <button class="action-btn receive" id="openReceive">
          <div class="action-icon">‚¨áÔ∏è</div>
          <div class="action-label">Receive</div>
        </button>

        <button class="action-btn swap" id="openSwap">
          <div class="action-icon">üîÅ</div>
          <div class="action-label">Swap</div>
        </button>

        <button class="action-btn trust" id="openTrust">
          <div class="action-icon">‚úîÔ∏è</div>
          <div class="action-label">Add trustline</div>
        </button>
      </div>

      <!-- small controls below -->
      <div class="top-controls">
        <button id="btnLock" class="control-btn">Lock</button>
        <button id="btnRefresh" class="control-btn">Refresh</button>
      </div>

      <!-- inline send panel -->
      <div class="send-panel" id="sendPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Send asset</strong>
          <button id="closeSend" style="background:none;border:none;font-weight:700;cursor:pointer">‚úï</button>
        </div>

        <label>From (Public key)</label>
        <input id="fromPub" placeholder="G..." />

        <label>Asset</label>
        <select id="sendAsset">
          <option value="XLM">XLM (native)</option>
          <option value="Laam">Laam</option>
          <option value="USDC">USDC</option>
        </select>

        <div class="send-row">
          <div>
            <label>Amount</label>
            <input id="sendAmount" type="number" step="0.0000001" placeholder="0.5" />
          </div>
          <div>
            <label>Destination</label>
            <input id="sendDest" placeholder="G..." />
          </div>
        </div>

        <label>Memo (optional)</label>
        <input id="sendMemo" />

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnSendNow" style="flex:1;background:linear-gradient(135deg,#2d9cff,#1976d2);color:#fff;border:none;padding:10px;border-radius:10px;font-weight:700">Send</button>
          <button id="btnBuild" style="flex:1;background:#eef5ff;border:none;padding:10px;border-radius:10px;font-weight:700">Build TX</button>
        </div>

        <div style="margin-top:10px" id="sendStatus"></div>
      </div>

      <!-- inline trust panel -->
      <div class="send-panel" id="trustPanel" style="display:none;margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Add USDC trustline</strong>
          <button id="closeTrust" style="background:none;border:none;font-weight:700;cursor:pointer">‚úï</button>
        </div>

        <label>Your Public Key</label>
        <input id="trustPub" placeholder="G..." />

        <label>Issuer (auto)</label>
        <input value="GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN" id="trustIssuer" />

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnAddTrust" style="flex:1;background:linear-gradient(135deg,#42a5f5,#00c6a7);color:#fff;border:none;padding:10px;border-radius:10px;font-weight:700">Add trustline</button>
        </div>
        <div style="margin-top:10px" id="trustStatus"></div>
      </div>

    </div>

    <div class="footer-space"></div>
  </div>

<script>
/* --------- Config & Globals ---------- */
const LAAM_TOKEN = { code: "Laam", issuer: "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64" };
const USDC_TOKEN = { code: "USDC", issuer: "GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN" };

let server;
let laamAsset, usdcAsset;

/* Initialize */
function init(){
  if(typeof StellarSdk === 'undefined'){ alert('Stellar SDK not loaded'); return; }
  server = new StellarSdk.Server('https://horizon.stellar.org');
  laamAsset = new StellarSdk.Asset(LAAM_TOKEN.code, LAAM_TOKEN.issuer);
  usdcAsset = new StellarSdk.Asset(USDC_TOKEN.code, USDC_TOKEN.issuer);
  attachUI();
  renderEmptyBalances();
}

/* UI helpers */
function attachUI(){
  document.getElementById('openSend').addEventListener('click', ()=>document.getElementById('sendPanel').style.display='block');
  document.getElementById('closeSend').addEventListener('click', ()=>document.getElementById('sendPanel').style.display='none');
  document.getElementById('openTrust').addEventListener('click', ()=>{ document.getElementById('trustPanel').style.display='block' });
  document.getElementById('closeTrust').addEventListener('click', ()=>document.getElementById('trustPanel').style.display='none');
  document.getElementById('btnRefresh').addEventListener('click', ()=>{ const pk = document.getElementById('fromPub').value; if(pk) loadBalances(pk); else showToast('Enter public key in From field'); });
  document.getElementById('btnSendNow').addEventListener('click', sendNow);
  document.getElementById('btnAddTrust').addEventListener('click', addTrustline);
  document.getElementById('btnLock').addEventListener('click', ()=>{ document.getElementById('fromPub').value=''; renderEmptyBalances(); showToast('Locked');});
  document.getElementById('btnBuild').addEventListener('click', buildTxPreview);
  document.getElementById('openReceive').addEventListener('click', ()=>{ navigator.clipboard && navigator.clipboard.writeText(document.getElementById('fromPub').value || ''); showToast('Your public key copied (if present)'); });
}

/* Render placeholders */
function renderEmptyBalances(){
  const list = document.getElementById('balancesList');
  list.innerHTML = '';
  const assets = [
    {code:'XLM', icon:'‚ú¶', balance:'0', fiat:'$0.00', price:'$0.409'},
    {code:'Laam', icon:'LA', balance:'0', fiat:'$0.00', price:'$0.056'},
    {code:'USDC', icon:'êÑÇ', balance:'0', fiat:'$0.00', price:'$1.00'}
  ];
  assets.forEach(a=>{
    const row = document.createElement('div'); row.className='asset-row';
    row.innerHTML = `<div class="asset-left"><div class="asset-icon">${a.icon}</div>
      <div><div class="asset-name">${a.code}</div><div class="asset-sub">${a.code==='USDC' ? 'USD stablecoin' : a.code==='Laam' ? 'Laam token' : 'Native XLM'}</div></div></div>
      <div class="asset-right"><div class="asset-balance">${a.balance}</div><div class="asset-fiat">${a.fiat} <div style="font-size:12px;color:var(--muted)">${a.price}</div></div></div>`;
    list.appendChild(row);
  });
  updateTotal();
}

/* Update total assets display */
function updateTotal(){
  const t = document.getElementById('balancesList');
  let total = 0;
  t.querySelectorAll('.asset-row').forEach((r,i)=>{
    const bal = parseFloat(r.querySelector('.asset-balance').textContent)||0;
    const price = (i===2)?1.0: (i===1?0.06:0.409);
    total += bal*price;
  });
  document.getElementById('totalAssets').textContent = total.toFixed(2);
}

/* Load balances for a public key */
async function loadBalances(publicKey){
  try{
    const acct = await server.loadAccount(publicKey);
    const list = document.getElementById('balancesList');
    list.innerHTML = '';
    const native = acct.balances.find(b=>b.asset_type==='native');
    const xlmBal = native ? parseFloat(native.balance) : 0;
    addAssetRow('XLM','‚ú¶',xlmBal,0.409,'Native XLM');
    let hasLaam=false, hasUSDC=false;
    acct.balances.forEach(b=>{
      if(b.asset_code==='Laam' && b.asset_issuer===LAAM_TOKEN.issuer){
        addAssetRow('Laam','LA', parseFloat(b.balance), 0.06, 'Laam token'); hasLaam=true;
      }
      if(b.asset_code==='USDC' && b.asset_issuer===USDC_TOKEN.issuer){
        addAssetRow('USDC','êÑÇ', parseFloat(b.balance), 1.0, 'USD Coin'); hasUSDC=true;
      }
    });
    if(!hasLaam) addAssetRow('Laam','LA',0,0.06,'Laam token');
    if(!hasUSDC) addAssetRow('USDC','êÑÇ',0,1.0,'USD Coin');
    updateTotal();
    showToast('Balances updated');
  }catch(e){
    console.error(e);
    showToast('Failed to load account. Is the public key valid and funded?');
  }
}

/* helper to append row */
function addAssetRow(code, icon, balance, price, subtitle){
  const list = document.getElementById('balancesList');
  const row = document.createElement('div'); row.className='asset-row';
  row.innerHTML = `<div class="asset-left"><div class="asset-icon">${icon}</div>
    <div><div class="asset-name">${code}</div><div class="asset-sub">${subtitle}</div></div></div>
    <div class="asset-right"><div class="asset-balance">${(+balance).toFixed(7).replace(/\.?0+$/,'')||'0'}</div>
    <div class="asset-fiat">$${(balance*price).toFixed(2)} <div style="font-size:12px;color:var(--muted)">$${price}</div></div></div>`;
  list.appendChild(row);
}

/* Show simple toast */
function showToast(msg){
  const prev = document.getElementById('toastDiv');
  if(prev) prev.remove();
  const d = document.createElement('div'); d.id='toastDiv';
  d.style.position='fixed'; d.style.bottom='22px'; d.style.left='50%'; d.style.transform='translateX(-50%)';
  d.style.background='rgba(0,0,0,0.8)'; d.style.color='#fff'; d.style.padding='10px 14px'; d.style.borderRadius='12px';
  d.style.zIndex=9999; d.textContent = msg;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),3000);
}

/* Build Transaction preview (unsigned) */
async function buildTxPreview(){
  try{
    const from = document.getElementById('fromPub').value.trim();
    const dest = document.getElementById('sendDest').value.trim();
    const assetCode = document.getElementById('sendAsset').value;
    const amount = document.getElementById('sendAmount').value;
    if(!from||!dest||!amount){ showToast('Fill From, Destination and Amount'); return; }
    const acct = await server.loadAccount(from);
    const fee = await server.fetchBaseFee();
    let asset = assetCode==='XLM' ? StellarSdk.Asset.native() : assetCode==='USDC' ? usdcAsset : laamAsset;
    const tx = new StellarSdk.TransactionBuilder(acct, {fee:fee, networkPassphrase:StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.payment({destination:dest, asset:asset, amount:amount}))
      .setTimeout(180)
      .build();
    const x = tx.toEnvelope().toXDR('base64');
    document.getElementById('sendStatus').innerHTML = `<div style="font-size:13px;color:var(--muted)">Unsigned TX (base64):</div><textarea style="width:100%;height:90px;margin-top:8px">${x}</textarea>`;
  }catch(e){
    console.error(e); showToast('Failed to build TX: '+e.message);
  }
}

/* Send Now - will ask for secret and submit */
async function sendNow(){
  try{
    const from = document.getElementById('fromPub').value.trim();
    const secret = prompt('Enter secret key (S...) to sign and send (never share it).');
    if(!secret){ showToast('Signing cancelled'); return; }
    const dest = document.getElementById('sendDest').value.trim();
    const assetCode = document.getElementById('sendAsset').value;
    const amount = document.getElementById('sendAmount').value;
    const memoText = document.getElementById('sendMemo').value || '';
    if(!from || !dest || !amount){ showToast('Fill From, Destination and Amount'); return; }

    const sourceKP = StellarSdk.Keypair.fromSecret(secret);
    if(sourceKP.publicKey() !== from){ if(!confirm('Secret does not match From public key. Continue?')) return; }

    const acct = await server.loadAccount(from);
    const fee = await server.fetchBaseFee();
    let asset = assetCode==='XLM' ? StellarSdk.Asset.native() : assetCode==='USDC' ? usdcAsset : laamAsset;

    const txb = new StellarSdk.TransactionBuilder(acct, {fee:fee, networkPassphrase:StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.payment({destination:dest, asset:asset, amount:amount}));

    if(memoText) txb.addMemo(StellarSdk.Memo.text(memoText));
    const tx = txb.setTimeout(180).build();
    tx.sign(sourceKP);
    const result = await server.submitTransaction(tx);
    showToast('Transaction successful: ' + result.hash);
    document.getElementById('sendStatus').innerText = 'Sent: ' + result.hash;
  }catch(e){
    console.error(e);
    const message = e.response && e.response.data ? JSON.stringify(e.response.data) : e.message;
    document.getElementById('sendStatus').innerText = 'Error: ' + message;
    showToast('Send failed');
  }
}

/* Add trustline (requires signing) */
async function addTrustline(){
  try{
    const pub = document.getElementById('trustPub').value.trim();
    if(!pub){ showToast('Enter your public key'); return; }
    const secret = prompt('Enter secret key (S...) to sign change_trust operation');
    if(!secret){ showToast('Cancelled'); return; }
    const sourceKP = StellarSdk.Keypair.fromSecret(secret);
    if(sourceKP.publicKey() !== pub){ if(!confirm('Secret does not match public key. Continue?')) return; }

    const acct = await server.loadAccount(pub);
    const fee = await server.fetchBaseFee();
    const tx = new StellarSdk.TransactionBuilder(acct, {fee:fee, networkPassphrase:StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.changeTrust({asset: usdcAsset, limit: '1000000'}))
      .setTimeout(180).build();
    tx.sign(sourceKP);
    const res = await server.submitTransaction(tx);
    document.getElementById('trustStatus').innerText = 'Trustline added: ' + res.hash;
    showToast('Trustline added');
  }catch(e){
    console.error(e);
    const msg = e.response && e.response.data ? JSON.stringify(e.response.data) : e.message;
    document.getElementById('trustStatus').innerText = 'Error: ' + msg;
    showToast('Failed to add trustline');
  }
}

/* Init on load */
window.addEventListener('load', init);
</script>
</body>
</html>